# Домашнее задание к занятию 6. «Troubleshooting»

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

### Ответ:
```
напишите список операций, которые вы будете производить для остановки запроса пользователя:
Определение текущей операци: db.currentOp()
Завершение операции по opid: db.killOp()

предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.
Метод maxTimeMS() устанавливает ограничение по времени для операции. Когда операция достигает указанного срока, MongoDB прерывает операцию.

```

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?

### Ответ:
```
Если в базе данных есть много-много ключей, срок действия которых истекает в одну и ту же секунду, и они составляют 
не менее 25% текущей совокупности ключей с установленным сроком действия, Redis может заблокировать, чтобы процент 
ключей, срок действия которых уже истек, был ниже 25%.
Такой подход необходим, чтобы не использовать слишком много памяти для ключей, срок действия которых уже истек, и 
обычно абсолютно безвреден, так как странно, что срок действия большого количества ключей истекает в одну и ту же 
секунду, но не исключено, что пользователь активно использовал EXPIREAT с тем же временем Unix.
Поэтому, надо иметь ввиду, что многие ключи, срок действия которых истекает в один и тот же момент, могут быть 
источником задержки.
```
 
## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?

### Ответ:
```
Это связано c долгой обработкой запроса в MySQL и по истечению таймаута происходит обрыв соединения.
Решению данной проблемы могут посодействовать различные действия:
    Увеличение времени таймаута запроса;
    Мониторинг и увеличение ресурсов сервера;
    Создание индексов и шардирование таблиц для оптимизации работы запросов БД.
```

## Задача 4


Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили эту проблему?

### Ответ:
```
Недостаточно памяти
Если посмотреть документацию к postgresql, то в ней говорится, что: можно увеличить память, увеличить файл 
подкачки. В Linux 2.6 и более поздних версиях дополнительной мерой является изменение поведения ядра таким образом, 
чтобы оно  не "перегружало" память. Хотя этот параметр не предотвратит вызов OOM killer в целом, но значительно 
снизит вероятность и, следовательно, приведет к более надежному поведению системы.
Это делается путем выбора режима строгой перегрузки через sysctl:
sysctl -w vm.overcommit_memory = 2
или поместив эквивалентную запись в /etc/sysctl.conf. Также можете изменить соответствующий параметр vm.
overcommit_ratio.

```
---

### Как cдавать задание

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---

